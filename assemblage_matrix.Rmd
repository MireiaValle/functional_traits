---
title: "assemblage_matrix"
author: "Mireia Valle"
date: "8/9/2019"
output: html_document
---

```{r setup}
##Libraries for data management
library (tidyverse) 
library (data.table)
library (reshape)
```

### Load species list 
```{r}
species_lt2018 <- read.csv('species_lt2018.csv')
unique (species_lt2018$am_sid) %>% length()#12368
species_list <- species_lt2018 %>%
    select(am_sid)
unique (species_list$am_sid) %>% length()#12368
```
###Load species-cell data
```{r}
dir_am <- '/home/shares/ohi/git-annex/globalprep/_raw_data/aquamaps'

spp_cells_final <- data.table::fread(file.path(dir_am, 'd2018/hcaf_species_native_ver0816c_fixed.csv'))
  ### fread() way faster
unique (spp_cells_final$am_sid) %>% length()#24904
sum(is.na(spp_cells_final$loiczid))
```
###Join tables using "am_sid" common to both `spp_cells_final` and `species_lt2018` to get a table where only the data on selected marine fish species is shown. Use `data.table` keyed join.

```{r}
spp_cells_final_keyed <- spp_cells_final %>%
  data.table(key = "am_sid")
head (spp_cells_final_keyed)
unique (spp_cells_final_keyed$am_sid) %>% length()#24904
sum(is.na(spp_cells_final_keyed$loiczid))#0

species_list_keyed <- species_list %>%
  data.table(key = "am_sid")
head (species_list_keyed)
unique (species_list_keyed$am_sid) %>% length()#12368

spp_cells_selected <- spp_cells_final_keyed[species_list_keyed, nomatch = 0]

head (spp_cells_selected)
unique (spp_cells_selected$am_sid) %>% length()#12365
sum(is.na(spp_cells_selected$am_sid))
sum(is.na(spp_cells_selected$loiczid))
```

###use spread() to turn the am_sid into column names, with the prob as the value in the cell

#seleccionamos las 10 primeras especies
asdf <- head(unique(spp_cells_selected$am_sid), 10)
asdf
#selecciona datos en hs sobre las 10 primeras especies
asdf_hs <- spp_cells_selected %>% filter(am_sid %in% asdf)
head(asdf_hs)

prueba <- asdf_hs %>%
    spread(am_sid, prob, fill = 0)

#spread 
head (spp_cells_selected)
spread <- spp_cells_selected %>%
    spread(am_sid, prob, fill = 0)

spp_cells_selected[14848064:14848071,]

prueba2 <- filter (spp_cells_selected, spp_cells_selected$am_sid  )